# .idx/modules/packages.nix
# Minimal package set - only essential tools
{ extendedPkgs, gstreamerDaemon, gstreamerAndroid, config }:

let
  # Android build module
  androidBuild = import ./gstreamer-daemon/android-build.nix {
    inherit (extendedPkgs) pkgs;
    inherit extendedPkgs;
  };

  # GStreamer Android helper package
  gstreamerAndroidPackage = extendedPkgs.stdenv.mkDerivation {
    name = "gstreamer-android-setup";
    version = "1.0.0";
    
    src = extendedPkgs.writeText "dummy" "";
    buildInputs = [ gstreamerAndroid.source ];
    
    installPhase = ''
      mkdir -p $out/bin
      
      cat > $out/bin/gstreamer-android-path << 'EOF'
#!/usr/bin/env bash
echo "${gstreamerAndroid.source}"
EOF
      chmod +x $out/bin/gstreamer-android-path
      
      cat > $out/bin/verify-gstreamer-android << 'EOF'
#!/usr/bin/env bash
TARBALL="${gstreamerAndroid.source}"
if [ -f "$TARBALL" ]; then
  echo "✅ GStreamer for Android found at: $TARBALL"
  echo "   Size: $(du -h "$TARBALL" | cut -f1)"
  exit 0
else
  echo "❌ GStreamer for Android not found!"
  exit 1
fi
EOF
      chmod +x $out/bin/verify-gstreamer-android
    '';
  };

in

(with extendedPkgs; [
  # ========================================================================
  # MINIMAL RUST TOOLCHAIN
  # ========================================================================
  rustup                # Rust installer
  cargo-ndk             # For Android builds
  
  # ❌ REMOVED to save space:
  # cargo-watch         # ~100MB (only for dev)
  # cargo-edit          # ~50MB (only for dep management)
  # cargo-outdated      # ~50MB (only for dep checking)
  # cargo-apk           # ~100MB (replaced by cargo-ndk)

  # ========================================================================
  # ANDROID SDK/NDK (minimal from overlay)
  # ========================================================================
  androidSdk            # Already minimized in overlay
  
  # ========================================================================
  # JAVA/GRADLE (minimal)
  # ========================================================================
  jdk17                 # Java 17 (required for Gradle)
  # Note: gradle will be downloaded by gradlew wrapper
  
  # ========================================================================
  # ESSENTIAL BUILD TOOLS ONLY
  # ========================================================================
  gcc                   # C compiler
  pkg-config            # Package config
  gnumake               # Make
  
  # ❌ REMOVED to save space:
  # cmake               # ~200MB (Android NDK has cmake)
  # perl                # ~100MB (not needed for this project)
  # automake            # ~50MB (only for autotools projects)
  # autoconf            # ~50MB (only for autotools projects)
  # libtool             # ~50MB (only for autotools projects)

  # ========================================================================
  # MINIMAL SYSTEM LIBRARIES (for host dev only)
  # ========================================================================
  glib                  # Required by GStreamer
  glib.dev
  openssl               # For Rust TLS
  openssl.dev
  libffi                # Required by GLib
  
  # ========================================================================
  # GSTREAMER (minimal - only for host development)
  # ========================================================================
  gst_all_1.gstreamer
  gst_all_1.gstreamer.dev
  gst_all_1.gst-plugins-base      # Essential plugins
  gst_all_1.gst-plugins-base.dev
  
  # ❌ REMOVED to save ~2GB:
  # gst_all_1.gst-plugins-good    # ~500MB
  # gst_all_1.gst-plugins-bad     # ~800MB
  # gst_all_1.gst-plugins-ugly    # ~300MB
  # gst_all_1.gst-libav           # ~200MB
  # gst_all_1.gst-devtools        # ~100MB
  # gst_all_1.gst-editing-services # ~100MB
  # gst_all_1.gst-vaapi           # ~50MB

  # ========================================================================
  # NO MULTIMEDIA CODECS (use Android's instead)
  # ========================================================================
  # ❌ REMOVED to save ~500MB:
  # libva
  # libvpx
  # x264
  # x265

  # ========================================================================
  # NO GUI DEPENDENCIES (headless build)
  # ========================================================================
  # ❌ REMOVED to save ~300MB:
  # libxkbcommon
  # libGL
  # wayland
  # xorg.libXcursor
  # xorg.libXrandr
  # xorg.libXi
  # xorg.libX11

  # ========================================================================
  # ESSENTIAL ANDROID TOOLS ONLY
  # ========================================================================
  # ❌ REMOVED to save ~200MB:
  # adb-sync            # Not essential
  # scrcpy              # Nice to have but not required
  
  # ========================================================================
  # MINIMAL ARCHIVE/UTILITY TOOLS
  # ========================================================================
  xz                    # For .tar.xz extraction
  gnutar                # Tar utility
  git                   # Version control
  curl                  # Downloads
  
  # ❌ REMOVED:
  # python311           # ~500MB (not needed unless using gstd Python)
  
]) ++ gstreamerDaemon.packages 
   ++ [ androidBuild.package gstreamerAndroidPackage ]